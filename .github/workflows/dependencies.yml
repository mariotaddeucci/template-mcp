name: Dependency Management

on:
  # Check dependencies weekly
  schedule:
    - cron: '0 8 * * 1'  # Every Monday at 8 AM UTC
  # Manual trigger
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"

jobs:
  check-dependencies:
    name: Check Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      run: |
        echo "ğŸ Setting up Python ${{ env.PYTHON_VERSION }} for dependency checks"
        uv python install ${{ env.PYTHON_VERSION }}
        python --version

    - name: Check for dependency updates
      run: |
        echo "ğŸ” Checking for outdated dependencies and project health"
        echo "Installing current dependencies..."
        uv sync --all-extras --verbose
        echo ""
        echo "ğŸ“¦ Current dependency tree:"
        uv tree
        echo ""
        echo "âœ… Dependency check completed"
        
    - name: Security audit
      run: |
        echo "ğŸ”’ Running dependency security audit"
        echo "Checking for known vulnerabilities in dependencies..."
        # Check for known vulnerabilities in dependencies
        uv run pip-audit --desc || echo "âš ï¸ pip-audit not available, skipping security audit"
        echo "âœ… Security audit completed"
      continue-on-error: true

    - name: Test with latest dependencies
      run: |
        echo "ğŸ§ª Testing project with current dependency versions"
        echo "Running basic test suite to ensure compatibility..."
        uv run task test --verbose
        echo "âœ… Project works correctly with current dependencies"

  validate-lockfile:
    name: Validate Lock File
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      run: |
        echo "ğŸ Setting up Python ${{ env.PYTHON_VERSION }} for lockfile validation"
        uv python install ${{ env.PYTHON_VERSION }}
        python --version

    - name: Validate uv.lock is up to date
      run: |
        echo "ğŸ” Validating that uv.lock file is up to date"
        echo "This ensures the lockfile matches pyproject.toml dependencies"
        uv lock --check --verbose
        echo "âœ… Lock file is valid and up to date"
        
    - name: Check sync status
      run: |
        echo "ğŸ”„ Checking if environment can be synchronized correctly"
        echo "This verifies that the lockfile can create a working environment"
        uv sync --all-extras --check --verbose
        echo "âœ… Environment synchronization check passed"

    - name: Display dependency summary
      run: |
        echo "ğŸ“Š Dependency Summary:"
        echo "========================"
        uv sync --all-extras
        echo ""
        echo "ğŸ“¦ Installed packages summary:"
        uv pip list --format=columns | head -20
        echo ""
        echo "ğŸ”¢ Total installed packages:"
        uv pip list | wc -l
        echo "âœ… Dependency analysis completed"
